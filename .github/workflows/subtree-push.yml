name: Subtree Push

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Subtree to push (or all)"
        type: choice
        default: all
        options:
          - all
          - lnmp-examples
          - lnmp-sdk-go
          - lnmp-sdk-js
          - lnmp-sdk-rust
          - lnmp-sdk-python
          - lnmp-cli
          - lnmp-mcp
  push:
    branches: [main]
    paths:
      - examples/**
      - sdk/go/**
      - sdk/js/**
      - sdk/rust/**
      - sdk/python/**
      - tools/cli/**
      - tools/mcp/**
      - scripts/subtree-sync.sh
      - SUBTREES.md

permissions:
  contents: read

jobs:
  push-subtrees:
    runs-on: ubuntu-latest
    env:
      TARGET: ${{ github.event_name == 'workflow_dispatch' && inputs.target || 'all' }}
      PUSH_TOKEN: ${{ secrets.SUBTREE_PUSH_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: lnmp-examples
            repo: lnmplang/lnmp-examples
            prefix: examples
            branch: main
          - name: lnmp-sdk-go
            repo: lnmplang/lnmp-sdk-go
            prefix: sdk/go
            branch: main
          - name: lnmp-sdk-js
            repo: lnmplang/lnmp-sdk-js
            prefix: sdk/js
            branch: main
          - name: lnmp-sdk-rust
            repo: lnmplang/lnmp-sdk-rust
            prefix: sdk/rust
            branch: main
          - name: lnmp-sdk-python
            repo: lnmplang/lnmp-sdk-python
            prefix: sdk/python
            branch: main
          - name: lnmp-cli
            repo: lnmplang/lnmp-cli
            prefix: tools/cli
            branch: main
          - name: lnmp-mcp
            repo: lnmplang/lnmp-mcp
            prefix: tools/mcp
            branch: main

    steps:
      - name: Ensure push token is present
        run: |
          if [ -z "$PUSH_TOKEN" ]; then
            echo "SUBTREE_PUSH_TOKEN secret is required to push to external repos."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config url."https://${PUSH_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Push ${{ matrix.name }} subtree
        if: env.TARGET == 'all' || env.TARGET == matrix.name
        run: |
          chmod +x scripts/subtree-sync.sh
          git remote remove "${{ matrix.name }}" 2>/dev/null || true
          git remote add "${{ matrix.name }}" "https://github.com/${{ matrix.repo }}.git"
          scripts/subtree-sync.sh push "${{ matrix.name }}" "${{ matrix.prefix }}" "${{ matrix.branch }}"
