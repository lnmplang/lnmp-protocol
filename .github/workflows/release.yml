name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type for release preparation'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  prepare:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces --version 0.4.2 --locked --force

      - name: Bump workspace version
        id: version
        env:
          BUMP: ${{ github.event.inputs.version_bump }}
        run: |
          set -euo pipefail

          cargo workspaces version "$BUMP" \
            --no-git-commit \
            --yes

          NEW_VERSION=$(grep -A 5 '^\[workspace\.package\]' Cargo.toml | grep '^version =' | head -n1 | sed 's/.*"//;s/"//')
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Next release version: $NEW_VERSION"

      - name: Update README and CHANGELOG
        env:
          VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          set -euo pipefail

          if [ -f README.md ]; then
            sed -i "s/Current Version: v.*/Current Version: v$VERSION/" README.md || true
            sed -i "s/lnmp = \".*\"/lnmp = \"$VERSION\"/" README.md || true
          fi

          if [ -f CHANGELOG.md ]; then
            TODAY=$(date +%Y-%m-%d)
            awk -v version="$VERSION" -v today="$TODAY" '
              BEGIN { inserted = 0 }
              {
                print $0
                if (!inserted && $0 ~ /^## \[Unreleased\]/) {
                  print ""
                  print "## [" version "] - " today
                  print ""
                  inserted = 1
                }
              }
            ' CHANGELOG.md > CHANGELOG.md.tmp
            mv CHANGELOG.md.tmp CHANGELOG.md
          fi

      - name: Show release diff
        run: git status -sb && git diff

      - name: Manual follow-up instructions
        env:
          VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          echo "::notice title=Release prep complete::"
          echo "1. Create a branch (e.g. release/v$VERSION) from this commit."
          echo "2. Commit the staged changes (Cargo.toml, README.md, CHANGELOG.md, etc.)."
          echo "3. Open a pull request targeting main and include the changelog diff for review."
          echo "4. Once merged, tag the commit with v$VERSION to trigger the publish workflow."

  checks:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cargo fmt
        run: cargo fmt --all --check

      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Cargo tests
        run: cargo test --workspace --all-targets

      - name: Verify protocol examples
        run: cargo run -p lnmp-compliance-tests --bin lnmp-verify-examples

      - name: Cargo doc
        run: cargo doc --workspace --no-deps

  publish:
    if: startsWith(github.ref, 'refs/tags/')
    needs: checks
    runs-on: ubuntu-latest
    environment: production
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRIES_CRATES_IO_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces --version 0.4.2 --locked --force

      - name: Publish crates
        run: |
          set -euo pipefail

          cargo workspaces publish \
            --publish-as-is \
            --allow-dirty \
            --yes

      - name: Generate release notes
        id: notes
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"

          awk -v version="$VERSION" '
            BEGIN { capture = 0 }
            /^## \[/ {
              if (capture) { exit }
              if ($0 ~ "\\[" version "\\]") { capture = 1; next }
            }
            capture { print }
          ' CHANGELOG.md > release-notes.md

          if [ ! -s release-notes.md ]; then
            echo "Release notes for ${TAG}" > release-notes.md
            echo "" >> release-notes.md
            echo "Changelog entry for ${TAG} was not found automatically. Please update CHANGELOG.md." >> release-notes.md
          fi

          echo "version=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${GITHUB_REF_NAME}" \
            --title "Release ${GITHUB_REF_NAME}" \
            --notes-file release-notes.md \
            --target "${GITHUB_SHA}"
