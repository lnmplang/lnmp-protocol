name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Semantic version bump to apply'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

permissions:
  contents: write
  packages: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    runs-on: ubuntu-latest
    environment: production
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRIES_CRATES_IO_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_BOT_TOKEN }}

      - name: Ensure on main branch
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$BRANCH" != "main" ]; then
            echo "This workflow must run from the main branch (current: $BRANCH)."
            exit 1
          fi

      - name: Configure Git
        run: |
          git config user.name "lnmp-release-bot"
          git config user.email "bot@lnmp.io"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces --version 0.4.2 --locked --force

      - name: Determine last tag
        id: tags
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "last_tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          if [ -n "$LAST_TAG" ]; then
            if [ -z "$(git log "$LAST_TAG"..HEAD --oneline)" ]; then
              echo "No commits since last tag ($LAST_TAG)."
              exit 1
            fi
          fi

      - name: Bump workspace version
        id: version
        env:
          BUMP: ${{ github.event.inputs.version_bump }}
        run: |
          set -euo pipefail

          cargo workspaces version "$BUMP" \
            --yes \
            --no-individual-tags \
            --no-git-tag \
            --message "chore: release %v"

          NEW_VERSION=$(grep -A 5 '^\[workspace\.package\]' Cargo.toml | grep '^version =' | head -n1 | sed 's/.*"//;s/"//')
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Cargo fmt
        run: cargo fmt --all --check

      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Cargo tests
        run: cargo test --workspace --all-targets

      - name: Verify protocol examples
        run: cargo run -p lnmp-compliance-tests --bin lnmp-verify-examples

      - name: Cargo doc
        run: cargo doc --workspace --no-deps

      - name: Publish crates
        run: |
          set -euo pipefail
          cargo workspaces publish \
            --publish-as-is \
            --yes \
            --locked \
            --allow-dirty

      - name: Tag release
        env:
          VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          git tag -a "v$VERSION" -m "Release v$VERSION"

      - name: Push changes
        env:
          VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          git push origin main
          git push origin "v$VERSION"

      - name: Generate release notes
        id: notes
        env:
          LAST_TAG: ${{ steps.tags.outputs.last_tag }}
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          TAG="v${VERSION}"
          if [ -n "$LAST_TAG" ]; then
            git log "$LAST_TAG"..HEAD --pretty=format:"- %s (%h)" > release-notes.md
          else
            git log --pretty=format:"- %s (%h)" > release-notes.md
          fi
          if [ ! -s release-notes.md ]; then
            echo "- Automated release $TAG" > release-notes.md
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_BOT_TOKEN }}
        run: |
          gh release create "${{ steps.notes.outputs.tag }}" \
            --title "Release ${{ steps.notes.outputs.tag }}" \
            --notes-file release-notes.md \
            --target main
